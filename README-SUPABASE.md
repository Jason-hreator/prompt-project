# Supabase集成说明

本文档提供了关于如何将应用程序与Supabase数据库集成的指南。

## 前提条件

1. Supabase账户
2. 已创建的Supabase项目
3. Supabase URL和密钥
4. Node.js环境

## 安装依赖

```bash
npm install @supabase/supabase-js
```

## 数据库表结构

以下是在Supabase中需要创建的表结构：

### 1. users 表

```sql
create table users (
  id bigint generated by default as identity primary key,
  username text not null,
  name text,
  email text unique not null,
  password text,
  role text default 'user',
  status text default '活跃',
  avatar text,
  bio text,
  website text,
  location text,
  prompts_count integer default 0,
  comments_count integer default 0,
  likes_count integer default 0,
  register_date timestamp with time zone default now(),
  last_login timestamp with time zone
);

-- 启用RLS (行级安全)
alter table users enable row level security;
```

### 2. prompts 表

```sql
create table prompts (
  id bigint generated by default as identity primary key,
  title text not null,
  content text not null,
  description text,
  category text,
  model text,
  user_id bigint references users(id) on delete cascade,
  status text default '待审核',
  date timestamp with time zone default now(),
  likes integer default 0,
  reviewed_by bigint references users(id),
  reviewed_at timestamp with time zone
);

-- 启用RLS
alter table prompts enable row level security;
```

### 3. comments 表

```sql
create table comments (
  id bigint generated by default as identity primary key,
  prompt_id bigint references prompts(id) on delete cascade,
  user_id bigint references users(id) on delete cascade,
  content text not null,
  date timestamp with time zone default now(),
  likes integer default 0
);

-- 启用RLS
alter table comments enable row level security;
```

### 4. likes 表

```sql
create table likes (
  user_id bigint references users(id) on delete cascade,
  prompt_id bigint references prompts(id) on delete cascade,
  created_at timestamp with time zone default now(),
  primary key (user_id, prompt_id)
);

-- 启用RLS
alter table likes enable row level security;
```

### 5. categories 表

```sql
create table categories (
  id bigint generated by default as identity primary key,
  name text not null unique,
  description text,
  icon text,
  prompt_count integer default 0
);

-- 启用RLS
alter table categories enable row level security;
```

## 环境变量设置

创建一个`.env.local`文件在项目根目录，添加以下内容：

```
NEXT_PUBLIC_SUPABASE_URL=https://your-project-id.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
```

## 数据迁移

按照以下步骤将现有数据迁移到Supabase：

1. 确保所有必要的表已在Supabase中创建。
2. 在项目根目录运行迁移脚本：

```bash
npm run migrate
```

迁移脚本将执行以下操作：
- 将用户数据从`data/users.json`导入到`users`表
- 将提示词数据从`data/prompts.json`导入到`prompts`表
- 将评论数据从`data/comments.json`导入到`comments`表
- 将点赞数据从`data/user-likes.json`导入到`likes`表

## RLS (行级安全) 策略

为确保数据安全，建议为每个表配置适当的RLS策略。以下是一些示例策略：

### users 表策略

```sql
-- 公开读取用户信息
create policy "Public profiles are viewable by everyone."
  on users for select
  using (true);

-- 仅本人可以更新自己的信息
create policy "Users can update own profile."
  on users for update
  using (auth.uid() = id);
```

### prompts 表策略

```sql
-- 公开已审核的提示词
create policy "Public prompts are viewable by everyone."
  on prompts for select
  using (status = '已审核');

-- 用户可以查看自己的所有提示词
create policy "Users can view own prompts."
  on prompts for select
  using (auth.uid() = user_id);

-- 用户可以创建提示词
create policy "Users can create prompts."
  on prompts for insert
  with check (auth.uid() = user_id);

-- 用户可以更新自己的提示词
create policy "Users can update own prompts."
  on prompts for update
  using (auth.uid() = user_id);
```

## 故障排除

1. **认证问题**: 确保你的Supabase URL和密钥正确配置在`.env.local`文件中。

2. **数据迁移失败**: 检查迁移脚本的控制台输出，查找具体错误。常见问题包括字段不匹配或外键约束。

3. **权限错误**: 确保正确配置了RLS策略，并且用户有适当的权限执行所需操作。

4. **数据不显示**: 如果迁移后数据不显示，检查API调用是否正确使用了新的Supabase客户端方法。

## 相关文件

- `lib/supabase.ts`: Supabase客户端配置
- `lib/api.ts`: API函数，用于与Supabase交互
- `lib/auth.ts`: 认证函数，用于处理用户登录和注册
- `scripts/migrate-to-supabase.js`: 数据迁移脚本

## 其他资源

- [Supabase文档](https://supabase.com/docs)
- [Supabase JavaScript客户端](https://supabase.com/docs/reference/javascript/introduction)
- [Next.js与Supabase集成](https://supabase.com/docs/guides/getting-started/quickstarts/nextjs) 